/*
 * 轻应用Baas平台API
 * demo
 *
 * OpenAPI spec version: 1.0
 * 
 *
 * NOTE: This class is auto generated by the swagger code generator program.
 * https://github.com/swagger-api/swagger-codegen.git
 * Do not edit the class manually.
 */


package com.chinamobile.iot.baas.sdk;

import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.*;

@javax.annotation.Generated(value = "io.swagger.codegen.languages.JavaClientCodegen", date = "2018-06-26T17:00:09.998+08:00")
public class SignatureUtil {


   public static String signature(String accessId,String accessKey,String method,Map<String,Object> params) throws Exception {

          String nonce = UUID.randomUUID().toString().replace("-","");

          Long timestamp = System.currentTimeMillis();

          String authPerfixString = "accessId="+accessId+"&nonce="+nonce+"&timestamp="+timestamp;

          String signingKey = HMACSHA1Util.HmacSHA1Encode(accessKey,authPerfixString);

          params.remove("pageNum");
          params.remove("pageSize");

          String paramsString = "";
          if(!params.isEmpty()) paramsString = paramSort(params);

          String signatureContent = method + "-" + paramsString;

          String signature = HMACSHA1Util.HmacSHA1Encode(signingKey,signatureContent);

          String encodeSignature = URLEncoder.encode(signature,"UTF-8");

          String authCode = authPerfixString + "&signature="+ encodeSignature;

          return authCode;
      }

        /**
           * 将Map的参数集合按照字典排序，输出此类格式的字符串
           * 例：email=12345678%40qq.com&mobile=13000000000
           */
        public static String paramSort(Map<String,Object> paramMap) throws UnsupportedEncodingException {
            Collection<String> paramSet= paramMap.keySet();
            List paramList=new ArrayList<String>(paramSet);
            Collections.sort(paramList);
            StringBuffer paramsb = new StringBuffer();
            for(int i=0;i<paramList.size();i++){
                paramsb.append(paramList.get(i)).append("=").append(URLEncoder.encode(String.valueOf(paramMap.get(paramList.get(i))), "utf8").replaceAll("\\+", "%20")).append("&");
            }
            return paramsb.toString().substring(0, paramsb.toString().length() - 1);
        }
}
